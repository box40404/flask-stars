<!DOCTYPE html>
<html>
<head>
    <title>Купить звезды</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/static/style.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        #notification {
            display: none;
            padding: 15px;
            margin-top: 10px;
            border-radius: 5px;
            text-align: center;
            font-weight: bold;
        }
        #notification.success {
            background-color: #4CAF50;
            color: white;
        }
        #notification.error {
            background-color: #f44336;
            color: white;
        }
    </style>
</head>
<body>
    <h1>Купить звезды</h1>
    <input type="number" id="amount" min="1" placeholder="Количество звезд">
    <input type="text" id="username" placeholder="@username">
    <select id="currency">
        <option value="TON">TON</option>
        <option value="USDT">USDT</option>
    </select>
    <p id="price">Стоимость: 0</p>
    <button onclick="buyStars()">Купить</button>
    <p id="invoice" style="display: none;"><a id="invoice-link" href="#" target="_blank">Оплатить</a></p>
    <p id="status" style="display: none;">Статус: <span id="status-text"></span></p>
    <div id="notification"></div>
    <script>
        const amountInput = document.getElementById("amount");
        const usernameInput = document.getElementById("username");
        const currencySelect = document.getElementById("currency");
        const priceDisplay = document.getElementById("price");
        const invoiceDisplay = document.getElementById("invoice");
        const invoiceLink = document.getElementById("invoice-link");
        const statusDisplay = document.getElementById("status");
        const statusText = document.getElementById("status-text");
        const notification = document.getElementById("notification");

        // Проверка Telegram Web App
        if (window.Telegram && window.Telegram.WebApp) {
            window.Telegram.WebApp.ready();
            const initData = window.Telegram.WebApp.initData;
            if (initData) {
                // Очищаем localStorage при загрузке через Web App
                localStorage.clear();
                fetch("/api/verify-init", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ initData })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.username) {
                            usernameInput.value = `@${data.username}`;
                            localStorage.setItem("telegram_user_id", data.user_id); // Сохраняем user_id
                        } else if (data.error) {
                            // Ошибка проверки initData, оставляем поле пустым
                            usernameInput.placeholder = "Введите @username";
                        }
                    })
                    .catch(() => {
                        // Ошибка сервера, оставляем поле пустым
                        usernameInput.placeholder = "Введите @username";
                    });
            }
        } else {
            // Восстанавливаем состояние из localStorage только для браузера
            const savedPurchaseId = localStorage.getItem("purchase_id");
            if (savedPurchaseId) {
                invoiceDisplay.style.display = "block";
                statusDisplay.style.display = "block";
                statusText.textContent = "Ожидание оплаты...";
                amountInput.value = localStorage.getItem("amount") || "";
                usernameInput.value = localStorage.getItem("username") || "";
                currencySelect.value = localStorage.getItem("currency") || "TON";
                checkPurchaseStatus(savedPurchaseId);
            }
        }

        fetch("/api/prices")
            .then(response => response.json())
            .then(prices => {
                function updatePrice() {
                    const amount = Number(amountInput.value);
                    const currency = currencySelect.value;
                    priceDisplay.textContent = amount ? 
                        `Стоимость: ${(prices[currency] * amount).toFixed(6)} ${currency}` : 
                        `Стоимость: 0 ${currency}`;
                }

                amountInput.addEventListener("input", updatePrice);
                currencySelect.addEventListener("change", updatePrice);

                // Инициализируем стоимость при загрузке
                updatePrice();
            })
            .catch(() => showNotification("Ошибка загрузки цен", "error"));

        function buyStars() {
            const amount = Number(amountInput.value);
            const username = usernameInput.value;
            const currency = currencySelect.value;
            if (!amount || !username || !currency) {
                showNotification("Заполните все поля", "error");
                return;
            }
            fetch("/api/purchase", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ 
                    amount, 
                    recipient_username: username, 
                    currency,
                    telegram_user_id: localStorage.getItem("telegram_user_id") || null
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        showNotification(data.error, "error");
                    } else {
                        // Сохраняем данные в localStorage только для браузера
                        if (!window.Telegram || !window.Telegram.WebApp) {
                            localStorage.setItem("purchase_id", data.purchase_id);
                            localStorage.setItem("amount", amount);
                            localStorage.setItem("username", username);
                            localStorage.setItem("currency", currency);
                        }
                        // Показываем элементы
                        invoiceDisplay.style.display = "block";
                        invoiceLink.href = data.invoice_url;
                        invoiceLink.textContent = `Оплатить ${amount} звезд (${currency})`;
                        statusDisplay.style.display = "block";
                        statusText.textContent = "Ожидание оплаты...";
                        // Запускаем автоматический опрос
                        checkPurchaseStatus(data.purchase_id);
                    }
                })
                .catch(() => showNotification("Ошибка сервера", "error"));
        }

        function checkPurchaseStatus(purchaseId) {
            const interval = setInterval(() => {
                fetch(`/api/purchase/${purchaseId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.error) {
                            statusText.textContent = `Ошибка: ${data.error}`;
                            showNotification(`Ошибка: ${data.error}`, "error");
                            clearInterval(interval);
                            localStorage.clear();
                        } else if (data.status === "completed") {
                            statusText.textContent = "Покупка завершена!";
                            showNotification("Покупка успешно завершена!", "success");
                            clearInterval(interval);
                            localStorage.clear();
                            amountInput.value = "";
                            usernameInput.value = usernameInput.readOnly ? usernameInput.value : "";
                            currencySelect.value = "TON";
                        } else if (data.status === "failed") {
                            statusText.textContent = `Ошибка: свяжитесь с поддержкой: "https://t.me/HappySupportStars"`;
                            showNotification(`Ошибка: свяжитесь с поддержкой: "https://t.me/HappySupportStars"`, "error");
                            clearInterval(interval);
                            localStorage.clear();
                        } else if (data.status === "cancelled") {
                            statusText.textContent = `Оплата не произошла в течение 15 минут, счет отменен.`;
                            showNotification(`Оплата не произошла в течение 15 минут, счет отменен.`, "error");
                            clearInterval(interval);
                            localStorage.clear();
                        } else {
                            statusText.textContent = "Ожидание оплаты...";
                        }
                    })
                    .catch(() => {
                        statusText.textContent = "Ошибка проверки статуса";
                        showNotification("Ошибка проверки статуса", "error");
                        clearInterval(interval);
                        localStorage.clear();
                    });
            }, 5000);
        }

        function showNotification(message, type) {
            notification.textContent = message;
            notification.className = type; // 'success' or 'error'
            notification.style.display = 'block';
            setTimeout(() => {
                notification.style.display = 'none';
            }, 5000); // Скрыть через 5 секунд
        }
    </script>
</body>
</html>

